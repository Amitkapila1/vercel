<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Amit 2.0</title>
  <base href="/">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script> 
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/primeng/13.4.1/resources/primeng.min.css" rel="stylesheet"/>
  <link href="https://unpkg.com/primeflex@3.2.1/primeflex.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/4.2.0/mdb.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/primeicons@5.0.0/primeicons.css rel=" stylesheet"=""/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/primeng/13.4.1/resources/themes/saga-blue/theme.min.css" rel="stylesheet"/>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  
  <script>
    // ServiceWorker Registration
    if('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/ngsw-worker.js').then(function(registration) {
                // Registration was successful
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
                
            }, function(err) {
                // registration failed :(
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
    if('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js').then(function(registration) {
                // Registration was successful
                console.log('ServiceWorker sw registration successful with scope: ', registration.scope);
                
                // Push API read subscription
                registration.pushManager.getSubscription().then(function(sub) {
                    if (sub === null) {
                        // Update UI to ask user to register for Push
                        console.log('Not subscribed to push service!');
                    } else {
                        // We have a subscription, update the database
                        console.log('Subscription object: ', sub);
                        storeSubscription(sub);
                    }
                });
                
            }, function(err) {
                // registration failed :(
                console.log('ServiceWorker sw registration failed: ', err);
            });
        });
    }
    
      
    
// PUSH API Subscription

    publicVapidKey : 'BFBmsKBimlVFV5uDwQYRJ1wJmrKQt5UVn4OS14DmfqyvIKLStdsD2CpHChq7alc0LL4XGucqt0yHANUp8cwhSRU';  // Checkout my github repository https://github.com/saurabhdaware/pwainit-node-pushapi for the backend setup code and generation of the vapid id.

    function storeSubscription(sub){
        // Call your subscription API here. If you are using https://github.com/saurabhdaware/pwainit-node-pushapi then you can keep the code same here.
        fetch('http://localhost:3000/subscribe',{
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify(sub)
        })
        .then(res => res.json())
        .then(res => console.log(res))
        .catch(err => console.warn("Make sure you are running the pushapi-backend code... cd pushapi-backend and run node index.js"));
    }

    // Helper function to convert Base 64
    function urlB64ToUint8Array(base64String) {
        try{
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
                    const rawData = window.atob(base64);
                    return Uint8Array.from([...rawData].map((char) => char.charCodeAt(0)));
        }catch(err){
            alert("Please add Vapid to publicVapidKey variable. Open console for more information");
            console.error("You have not set publicVapidKey. Open index.html and look for the line which defines publicVapidKey variable and paste your public vapid key in the value");
            console.log("If you dont have public vapid key yet checkout https://github.com/saurabhdaware/pwainit-node-pushapi for backend setup and generation of vapid keys");
            return err;
        }
    }

    // Subscribe user for push service, This returns us subscription object which can be used to send notifications from backend

    const applicationServerKey = urlB64ToUint8Array(publicVapidKey);
    console.log(applicationServerKey)
    function subscribeUser() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(function(reg) {
                reg.pushManager.subscribe({userVisibleOnly: true,applicationServerKey:applicationServerKey})
                    .then(function(sub) {
                        console.log(sub);
                        console.log('Endpoint URL: ', sub.endpoint);
                        console.log("post this data to your server and store in database, then use the endpoint to push notifications from server")
                        
                        // Pass sub to Server and store it. You will be using it to push notifications from your server
                        storeSubscription(sub);

                    }).catch(function(e) {
                        if (Notification.permission === 'denied') {
                            alert("Notification permission was denied. Please click lock icon beside url bar and allow notifications");
                            console.warn('Permission for notifications was denied');
                        } else {
                            console.warn("Please make sure you change publicVapidKey variable with your public vapid key generated from your backend");
                            console.log("Checkout https://github.com/saurabhdaware/pwainit-node-pushapi for example code and generation of the public vapid key");
                            console.error('Unable to subscribe to push', e);
                        }
                    });
            }).catch(e => {
                console.warn("Please make sure you change publicVapidKey variable with your public vapid key generated from your backend");
                console.log("Checkout https://github.com/saurabhdaware/pwainit-node-pushapi for example code and generation of the public vapid key");
                console.error('Unable to subscribe to push', e);
            })
        }
    }
    
  </script>
    
   
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1976d2">
  
</head>
<body>
     <!-- Notification Permission Ask // Its better to have a banner with buttons -->
     <br><button onclick="subscribeUser();" style="background-color:#f30;cursor:pointer;color:#fff;border:none;padding:10px 20px;position:fixed;top:10px;left:10px;z-index:100000">Allow Push Notifications</button>
  <app-root>
      <div class="main-spinner-wrapper">
        <div class="donut ">
        <div class="donut1">
          <div class="lds-dual-ring"></div>
          
        
        
        <div class="donut2"></div></div>
      </div>
      </div>
  </app-root>
  <noscript>Please enable JavaScript to continue using this application.</noscript>
</body>
</html>
